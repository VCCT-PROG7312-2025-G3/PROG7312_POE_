@using PROG7312_POE_.Services
@{
    ViewData["Title"] = "Service Request Status";
    var wards = (IEnumerable<string>)ViewBag.Wards ?? Array.Empty<string>();
}

<div class="container my-5">
    <h2 class="mb-4 text-primary fw-bold">Service Request Status</h2>

    <!-- Search Bar -->
    <div class="card mb-4 shadow-sm">
        <div class="card-body">
            <div class="input-group">
                <input id="srchId" type="text" class="form-control" placeholder="Search by ID or Title..." />
                <button id="btnSearch" class="btn btn-primary">Search / Track</button>
            </div>
            <div id="searchOut" class="mt-3"></div>
        </div>
    </div>

    <!-- Requests Table -->
    <div class="card shadow-sm">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="card-title mb-0">All Requests</h5>
                <button id="btnUrgent" class="btn btn-outline-danger btn-sm">Load Top 10 Urgent</button>
            </div>

            <div class="table-responsive">
                <table class="table table-hover align-middle" id="requestsTable">
                    <thead class="table-light">
                        <tr>
                            <th>Request ID</th>
                            <th>Title</th>
                            <th>Ward</th>
                            <th>Priority</th>
                            <th>Status</th>
                            <th>Submitted</th>
                            <th>Assigned</th>
                        </tr>
                    </thead>
                    <tbody id="urgentOut">
                        <tr><td colspan="7" class="text-muted text-center">No data loaded yet.</td></tr>
                    </tbody>
                </table>
            </div>

            <div class="mt-3">
                <button id="btnServe" class="btn btn-success">Serve Next</button>
                <div id="serveMsg" class="mt-2 text-success"></div>
            </div>
        </div>
    </div>

    <!-- Graph Tools -->
    <div class="card mt-4 shadow-sm">
        <div class="card-body">
            <h5 class="card-title">Graph Operations</h5>
            <div class="d-flex gap-2 align-items-center">
                <select id="wardSel" class="form-select w-auto">
                    @foreach (var w in wards)
                    {
                        <option>@w</option>
                    }
                </select>
                <select id="algoSel" class="form-select w-auto">
                    <option>BFS</option>
                    <option>DFS</option>
                </select>
                <button id="btnTrav" class="btn btn-outline-primary">Traverse</button>
                <button id="btnMst" class="btn btn-outline-secondary">Compute MST</button>
            </div>
            <div class="mt-3">
                <pre id="travOut" class="bg-light p-2 rounded small"></pre>
                <pre id="mstOut" class="bg-light p-2 rounded small"></pre>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        const $ = sel => document.querySelector(sel);

        // Search by ID
        $('#btnSearch').onclick = async () => {
            const id = $('#srchId').value;
            const r = await fetch(`/ServiceRequestStatus/Search?id=${encodeURIComponent(id)}`);
            if (!r.ok) {
                $('#searchOut').innerHTML = `<div class="alert alert-warning">No result found for "${id}".</div>`;
                return;
            }
            const j = await r.json();
            $('#searchOut').innerHTML = `
                <div class="alert alert-info">
                    <strong>${j.title}</strong> — ${j.status}<br>
                    Ward: ${j.ward}, Priority: ${j.priority}<br>
                    Submitted: ${j.created}
                </div>`;
        };

        // Load top 10 urgent
        $('#btnUrgent').onclick = async () => {
            const r = await fetch(`/ServiceRequestStatus/Urgent?take=10`);
            const j = await r.json();
            $('#urgentOut').innerHTML = j.map(x => `
                <tr>
                    <td>SR-${x.id.toString().padStart(4, '0')}</td>
                    <td>${x.title}</td>
                    <td>${x.ward}</td>
                    <td><span class="badge bg-danger">P${x.priority}</span></td>
                    <td><span class="badge bg-warning text-dark">${x.status}</span></td>
                    <td>${x.created}</td>
                    <td>Team ${(x.id % 3) + 65}</td>
                </tr>
            `).join('');
        };

        // Serve next
        $('#btnServe').onclick = async () => {
            const r = await fetch(`/ServiceRequestStatus/ServeNext`, { method: 'POST' });
            if (!r.ok) {
                $('#serveMsg').textContent = 'No items to serve.';
                return;
            }
            const j = await r.json();
            $('#serveMsg').textContent = `Serving #${j.id} — ${j.title}`;
            // refresh urgent list if visible
            if (document.getElementById('urgentOut').children.length > 0) {
                document.getElementById('btnUrgent').click();
            }
        };

        // Graph Traversal
        $('#btnTrav').onclick = async () => {
            const start = $('#wardSel').value, algo = $('#algoSel').value;
            const r = await fetch(`/ServiceRequestStatus/Traverse?start=${encodeURIComponent(start)}&algo=${algo}`);
            const j = await r.json();
            $('#travOut').textContent = `${algo} from ${start}: ${j.order.join(' -> ')}`;
        };

        // MST
        $('#btnMst').onclick = async () => {
            const start = $('#wardSel').value;
            const r = await fetch(`/ServiceRequestStatus/Mst?start=${encodeURIComponent(start)}`);
            const j = await r.json();
            $('#mstOut').textContent = `MST total ${j.total} | ` + j.edges.map(e => `${e.a}-${e.b}(${e.w})`).join(', ');
        };
    </script>
}
